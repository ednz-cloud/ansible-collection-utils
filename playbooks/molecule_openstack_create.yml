---
- name: Create
  hosts: localhost
  connection: local
  gather_facts: false
  no_log: "{{ molecule_no_log }}"
  tasks:
    - name: Include molecule vars
      ansible.builtin.include_tasks:
        file: tasks/vars.yml

    - name: Create OpenStack resources
      ansible.builtin.include_role:
        name: ednz_cloud.utils.molecule_openstack_platforms
      vars:
        molecule_openstack_platforms_action: create
        molecule_openstack_platforms_list: "{{ molecule_yml.platforms }}"
        molecule_openstack_platforms_uuid: "{{ uuid }}"
        molecule_openstack_platforms_key_name: "{{ key_name }}"

    - name: Persist identity file
      ansible.builtin.copy:
        dest: "{{ identity_file }}"
        content: "{{ molecule_openstack_platforms_keypair.keypair.private_key }}"
        mode: "0600"
      when: molecule_openstack_platforms_keypair is changed # noqa no-handler

    - name: Create molecule instances configuration
      block:
        - name: Initialize an empty list for storing all instances
          ansible.builtin.set_fact:
            all_instances: []

        - name: Retrieve server information
          openstack.cloud.server_info:
            server: "molecule-test-*-{{ uuid }}"
          register: server_info

        - name: Include server_addr tasks
          ansible.builtin.include_tasks: "tasks/server_addr.yml"
          loop: "{{ server_info.servers }}"

        - name: Wipe out instance config
          ansible.builtin.set_fact:
            instance_conf: {}

        - name: Convert instance config dict to a list
          ansible.builtin.set_fact:
            instance_conf: "{{ all_instances | map(attribute='ansible_facts.instance_conf_dict') | list }}"

        - name: Dump instance config
          ansible.builtin.copy:
            content: "{{ instance_conf }}"
            dest: "{{ molecule_instance_config }}"
            mode: "0600"

        - name: Wait for SSH banner (VPN-safe)
          ansible.builtin.wait_for:
            host: "{{ item.address }}"
            port: 22
            search_regex: '^SSH-'
            timeout: 5
          register: ssh_wait
          retries: 30
          delay: 5
          until: ssh_wait is succeeded
          loop: "{{ lookup('file', molecule_instance_config) | from_yaml }}"
